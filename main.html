<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1885ed">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/stylelogin.css">
  <title>PRIME-CHAT</title>
  <link rel="icon" href="img/logo.ico" type="image/x-icon">
</head>

<body>
  <i style="--clr:#ff00dd;"></i>
  <i style="--clr:#7700ff;"></i>
  <i style="--clr:#4470ff;"></i>

  <div class="form-container">
    <div id="authSection">
      <div class="toggle-panel">
        <button class="toggle-btn active" data-form="login">Login</button>
        <button class="toggle-btn" data-form="register">Register</button>
        <span class="slider"></span>
      </div>
      <div class="forms-wrapper">
        <!-- Login Form -->
        <form class="form login-form active" id="loginForm">
          <h2>Login</h2>
          <div class="inputBx">
            <input type="email" id="loginEmail" placeholder="Email" required>
          </div>
          <div class="inputBx">
            <input type="password" id="loginPassword" placeholder="Password" required>
          </div>
          <div class="inputBx">
            <input type="submit" value="Enter">
          </div>
          <div class="inputBx">
            <button type="button" class="google-btn" id="googleSignIn">Sign in with Google</button>
          </div>
        </form>

        <!-- Register Form -->
        <form class="form register-form" id="registerForm">
          <h2>Register</h2>
          <div class="inputBx">
            <input type="text" id="registerUsername" placeholder="Username" required>
          </div>
          <div class="inputBx">
            <input type="email" id="registerEmail" placeholder="Email" required>
          </div>
          <div class="inputBx">
            <input type="password" id="registerPassword" placeholder="Password" required>
          </div>
          <div class="inputBx">
            <input type="submit" value="Enter">
          </div>
        </form>
      </div>
    </div>

    <!-- Messaging Section (Hidden until logged in) -->
    <div id="messagingSection" style="display: none;">
      <h2>PRIME-CHAT</h2>
      <div class="inputBx">
        <input type="text" id="friendUsername" placeholder="Enter friend's username">
        <button class="google-btn" id="addFriendBtn">Add Friend</button>
      </div>
      <div class="inputBx">
        <h3>Friends</h3>
        <ul id="friendsList" style="color: #fff; list-style: none; padding: 0;"></ul>
      </div>
      <div class="inputBx">
        <h3>Messages</h3>
        <div id="chatArea" style="color: #fff; max-height: 200px; overflow-y: auto; border: 1px solid #7a7a7a; padding: 10px; border-radius: 15px;"></div>
        <input type="text" id="messageInput" placeholder="Type a message" style="margin-top: 10px;">
        <button class="google-btn" id="sendMessageBtn">Send</button>
      </div>
      <div class="inputBx">
        <button class="google-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, onSnapshot, addDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCl-GLnM_ZUOLRtCB61SG4TcZatESQvBIM",
      authDomain: "primechat-95269.firebaseapp.com",
      databaseURL: "https://primechat-95269-default-rtdb.firebaseio.com",
      projectId: "primechat-95269",
      storageBucket: "primechat-95269.firebasestorage.app",
      messagingSenderId: "998627379069",
      appId: "1:998627379069:web:e4a4d39952acae00dc2e14",
      measurementId: "G-T7MP8LQLJW"
    };

    // Initialize Firebase
    let firebaseInitialized = false;
    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      firebaseInitialized = true;

      // Expose Firebase functions to global scope
      window.firebase = {
        auth,
        db,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        updateProfile,
        onAuthStateChanged,
        signOut,
        doc,
        setDoc,
        getDoc,
        getDocs,
        collection,
        query,
        where,
        onSnapshot,
        addDoc,
        orderBy,
        Timestamp
      };
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Failed to initialize Firebase: ' + error.message);
    }
  </script>

  <script>
    // Wait for Firebase to initialize
    const waitForFirebase = () => {
      return new Promise((resolve) => {
        const check = () => {
          if (window.firebase && window.firebase.auth && window.firebase.db) {
            resolve(window.firebase);
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    };

    // Main script
    waitForFirebase().then(({ auth, db, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut, doc, setDoc, getDoc, getDocs, collection, query, where, onSnapshot, addDoc, orderBy, Timestamp }) => {
      const authSection = document.getElementById('authSection');
      const messagingSection = document.getElementById('messagingSection');
      let selectedFriendId = null;

      // Toggle between Login and Register forms
      const toggleBtns = document.querySelectorAll('.toggle-btn');
      const forms = document.querySelectorAll('.form');
      const slider = document.querySelector('.slider');

      toggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetForm = btn.dataset.form;
          toggleBtns.forEach(b => b.classList.remove('active'));
          forms.forEach(f => f.classList.remove('active'));
          btn.classList.add('active');
          document.querySelector(`.${targetForm}-form`).classList.add('active');
          const sliderWidth = btn.offsetWidth;
          const offsetLeft = btn.offsetLeft;
          slider.style.width = sliderWidth + 'px';
          slider.style.left = offsetLeft + 'px';
        });
      });

      // Login Form Submission
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!signInWithEmailAndPassword) {
          console.error('signInWithEmailAndPassword is not defined');
          alert('Authentication service unavailable.');
          return;
        }
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          // Handled by onAuthStateChanged
        } catch (error) {
          console.error('Login error:', error);
          alert('Login failed: ' + error.message);
        }
      });

      // Google Sign-In
      document.getElementById('googleSignIn').addEventListener('click', async () => {
        if (!GoogleAuthProvider || !signInWithPopup) {
          console.error('GoogleAuthProvider or signInWithPopup is not defined');
          alert('Google sign-in service unavailable.');
          return;
        }
        try {
          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await getDoc(userRef);
          if (!userSnap.exists()) {
            await setDoc(userRef, {
              username: user.displayName || 'Anonymous',
              email: user.email,
              createdAt: Timestamp.now()
            });
          }
          // Handled by onAuthStateChanged
        } catch (error) {
          console.error('Google Sign-In error:', error);
          alert('Google sign-in failed: ' + error.message);
        }
      });

      // Register Form Submission
      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!createUserWithEmailAndPassword || !updateProfile) {
          console.error('createUserWithEmailAndPassword or updateProfile is not defined');
          alert('Registration service unavailable.');
          return;
        }
        const username = document.getElementById('registerUsername').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          await updateProfile(user, { displayName: username });
          await setDoc(doc(db, 'users', user.uid), {
            username: username,
            email: email,
            createdAt: Timestamp.now()
          });
          // Handled by onAuthStateChanged
        } catch (error) {
          console.error('Registration error:', error);
          alert('Registration failed: ' + error.message);
        }
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          // Handled by onAuthStateChanged
        } catch (error) {
          console.error('Logout error:', error);
          alert('Logout failed: ' + error.message);
        }
      });

      // Add Friend
      document.getElementById('addFriendBtn').addEventListener('click', async () => {
        const friendUsername = document.getElementById('friendUsername').value.trim();
        if (!friendUsername) {
          alert('Please enter a username.');
          return;
        }
        try {
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('username', '==', friendUsername));
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) {
            alert('User not found.');
            return;
          }
          const friendData = querySnapshot.docs[0];
          const friendId = friendData.id;
          const currentUser = auth.currentUser;
          if (friendId === currentUser.uid) {
            alert('You cannot add yourself as a friend.');
            return;
          }
          const friendRef = doc(db, 'users', currentUser.uid, 'friends', friendId);
          await setDoc(friendRef, {
            username: friendData.data().username,
            addedAt: Timestamp.now()
          });
          document.getElementById('friendUsername').value = '';
          alert('Friend added successfully!');
        } catch (error) {
          console.error('Add friend error:', error);
          alert('Failed to add friend: ' + error.message);
        }
      });

      // Send Message
      document.getElementById('sendMessageBtn').addEventListener('click', async () => {
        const message = document.getElementById('messageInput').value.trim();
        if (!message) {
          alert('Please enter a message.');
          return;
        }
        if (!selectedFriendId) {
          alert('Please select a friend to message.');
          return;
        }
        try {
          const currentUser = auth.currentUser;
          const chatId = [currentUser.uid, selectedFriendId].sort().join('_');
          await addDoc(collection(db, 'chats', chatId, 'messages'), {
            senderId: currentUser.uid,
            message: message,
            timestamp: Timestamp.now()
          });
          document.getElementById('messageInput').value = '';
        } catch (error) {
          console.error('Send message error:', error);
          alert('Failed to send message: ' + error.message);
        }
      });

      // Display Friends
      const displayFriends = async (userId) => {
        const friendsList = document.getElementById('friendsList');
        friendsList.innerHTML = '';
        try {
          const friendsRef = collection(db, 'users', userId, 'friends');
          onSnapshot(friendsRef, (snapshot) => {
            friendsList.innerHTML = '';
            snapshot.forEach(doc => {
              const friend = doc.data();
              const li = document.createElement('li');
              li.textContent = friend.username;
              li.style.cursor = 'pointer';
              li.style.padding = '5px';
              li.style.borderBottom = '1px solid #7a7a7a';
              li.addEventListener('click', () => {
                selectedFriendId = doc internationalization
                document.querySelectorAll('#friendsList li').forEach(item => item.style.background = 'none');
                li.style.background = '#dd4444';
                loadMessages(userId, selectedFriendId);
              });
              friendsList.appendChild(li);
            });
          });
        } catch (error) {
          console.error('Error displaying friends:', error);
          alert('Failed to load friends: ' + error.message);
        }
      };

      // Load Messages
      const loadMessages = (userId, friendId) => {
        const chatArea = document.getElementById('chatArea');
        chatArea.innerHTML = '';
        const chatId = [userId, friendId].sort().join('_');
        const messagesRef = collection(db, 'chats', chatId, 'messages');
        const q = query(messagesRef, orderBy('timestamp', 'asc'));
        onSnapshot(q, async (snapshot) => {
          chatArea.innerHTML = '';
          for (const doc of snapshot.docs) {
            const message = doc.data();
            const senderId = message.senderId;
            const senderRef = doc(db, 'users', senderId);
            const senderSnap = await getDoc(senderRef);
            const senderUsername = senderSnap.exists() ? senderSnap.data().username : 'Unknown';
            const messageDiv = document.createElement('div');
            messageDiv.textContent = `${senderUsername}: ${message.message}`;
            messageDiv.style.padding = '5px';
            messageDiv.style.background = senderId === userId ? '#dd4444' : '#7a7a7a';
            messageDiv.style.borderRadius = '10px';
            messageDiv.style.margin = '5px 0';
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
          }
        });
      };

      // Auth State Listener
      if (onAuthStateChanged) {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            authSection.style.display = 'none';
            messagingSection.style.display = 'block';
            displayFriends(user.uid);
          } else {
            authSection.style.display = 'block';
            messagingSection.style.display = 'none';
            document.getElementById('friendsList').innerHTML = '';
            document.getElementById('chatArea').innerHTML = '';
            selectedFriendId = null;
          }
        });
      } else {
        console.error('onAuthStateChanged is not defined');
        alert('Authentication state monitoring unavailable.');
      }
    }).catch((error) => {
      console.error('Failed to load Firebase:', error);
      alert('Firebase is not initialized. Please check the console for errors.');
    });
  </script>
</body>

</html>